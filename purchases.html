<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Page | Vue MyDuka POS</title>

    <!-- Bootstrap + DataTables -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        #app {
            flex: 1;
        }

        .card {
            border-radius: 12px;
        }

        footer {
            background: #212529;
            color: white;
            text-align: center;
            padding: 12px 0;
            margin-top: auto;
        }

        .modal-header.bg-primary {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .modal-header.bg-warning {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
    </style>
</head>

<body>
<div id="app">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark bg-opacity-75 shadow-sm fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="index.html">MyDuka POS</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
      <ul class="navbar-nav">

        <li class="nav-item">
          <a class="nav-link" href="index.html">Home</a>
        </li>

        <li class="nav-item">
          <a class="nav-link " href="products.html">Products</a>
        </li>

        <li class="nav-item">
          <a class="nav-link active text-info fw-semibold" href="purchases.html">Purchases</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="sales.html">Sales</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="dashboard.html">Dashboard</a>
        </li>

        <li class="nav-item">
          <a class="nav-link text-danger fw-semibold" href="login.html" onclick="logout()">Logout</a>
        </li>

      </ul>
    </div>
  </div>
</nav>


    <!-- Page Header -->
    <div class="container text-center my-5 pt-5">
        <h2 class="fw-bold mt-4">Purchase Management</h2>
        <p class="text-muted">Record and track your product purchases</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#insertPurchaseModal">
            + Insert Purchase
        </button>
    </div>

    <!-- Insert Purchase Modal -->
    <div class="modal fade" id="insertPurchaseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="insertPurchaseLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="insertPurchaseLabel">Insert Purchase</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form @submit.prevent="addPurchase">
                        <div class="mb-3">
                            <label for="product_id" class="form-label fw-semibold">Product ID</label>
                            <input type="number" class="form-control" v-model="newPurchase.product_id" id="product_id" required>
                        </div>

                        <div class="mb-3">
                            <label for="stock_quantity" class="form-label fw-semibold">Stock Quantity</label>
                            <input type="number" class="form-control" v-model="newPurchase.stock_quantity" id="stock_quantity" required>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Purchase Modal -->
    <div class="modal fade" id="editPurchaseModal" tabindex="-1" aria-labelledby="editPurchaseLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold" id="editPurchaseLabel">Edit Purchase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="updatePurchase">
                        <input type="hidden" v-model="editPurchase.id">
                        <div class="mb-3">
                            <label for="edit_product" class="form-label fw-semibold">Product ID</label>
                            <input type="number" class="form-control" v-model="editPurchase.product_id" id="edit_product" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_stock_quantity" class="form-label fw-semibold">Stock Quantity</label>
                            <input type="number" class="form-control" v-model="editPurchase.stock_quantity" id="edit_stock_quantity" required>
                        </div>
                        <button type="submit" class="btn btn-warning w-100 fw-bold">Update Purchase</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchases Table -->
    <div class="container my-5">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <table class="display table table-striped align-middle" id="purchaseTable" style="width:100%">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Product ID</th>
                        <th>Stock Quantity</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="purchase in purchases" :key="purchase.id">
                        <td>{{ purchase.id }}</td>
                        <td>{{ purchase.product_id }}</td>
                        <td>{{ purchase.stock_quantity }}</td>
                        <td>{{ formatDate(purchase.created_at) }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" @click="openEditModal(purchase)">
                                <i class="bi bi-pencil-square"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" @click="deletePurchase(purchase.id)">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Footer -->
<footer>
    <small>© 2025 MyDuka POS — Smart Business Management</small>
</footer>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.7.7/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.8/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>

<script>
new Vue({
    el: "#app",
    data: {
        purchases: [],
        newPurchase: { product_id: '', stock_quantity: '' },
        editPurchase: { id: '', product_id: '', stock_quantity: '' }
    },
    methods: {
        async fetchPurchases() {
            try {
                const token = localStorage.getItem("token");
                const res = await axios.get("http://127.0.0.1:5000/purchases", { headers: { Authorization: "Bearer " + token } });
                this.purchases = res.data;
                setTimeout(() => { new DataTable('#purchaseTable'); }, 100);
            } catch (err) { console.error(err); }
        },
        async addPurchase() {
            try {
                const token = localStorage.getItem("token");
                await axios.post("http://127.0.0.1:5000/purchases", {
                    product_id: Number(this.newPurchase.product_id),
                    stock_quantity: Number(this.newPurchase.stock_quantity)
                }, { headers: { Authorization: "Bearer " + token }});
                this.newPurchase = { product_id: '', stock_quantity: '' };
                bootstrap.Modal.getInstance(document.getElementById('insertPurchaseModal')).hide();
                this.fetchPurchases();
            } catch (err) { console.error(err); }
        },
        openEditModal(purchase) {
            this.editPurchase = { ...purchase };
            new bootstrap.Modal(document.getElementById('editPurchaseModal')).show();
        },
        async updatePurchase() {
            try {
                const token = localStorage.getItem("token");
                await axios.put("http://127.0.0.1:5000/purchases/" + this.editPurchase.id, {
                    product_id: Number(this.editPurchase.product_id),
                    stock_quantity: Number(this.editPurchase.stock_quantity)
                }, { headers: { Authorization: "Bearer " + token }});
                bootstrap.Modal.getInstance(document.getElementById('editPurchaseModal')).hide();
                this.fetchPurchases();
            } catch (err) { console.error(err); }
        },
        async deletePurchase(id) {
            if(!confirm("Are you sure you want to delete this purchase?")) return;
            try {
                const token = localStorage.getItem("token");
                await axios.delete("http://127.0.0.1:5000/purchases/" + id, { headers: { Authorization: "Bearer " + token }});
                this.fetchPurchases();
            } catch (err) { console.error(err); }
        },
        formatDate(dateStr) {
            return new Date(dateStr).toLocaleString();
        }
    },
    mounted() {
        const token = localStorage.getItem("token");
        if(!token) { alert("Please login first."); window.location.href="login.html"; return; }
        this.fetchPurchases();
    }
});
</script>

</body>
</html>
